<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>íŒë§¤ì ê´€ë¦¬ | ê½ƒë³´ë¼ê°€ë“ </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols_Outlined&display=swap" rel="stylesheet"/>
    <script id="tailwind-config">
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        "primary": "#2d5f3f"
                    }
                },
            },
        }
    </script>
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400; }
    </style>
</head>
<body class="bg-gray-50">
<header class="sticky top-0 z-50 bg-white/80 backdrop-blur-md border-b">
<div class="max-w-7xl mx-auto px-6 h-20 flex items-center justify-between">
<div class="flex items-center gap-3">
<span class="text-2xl">ğŸŒ¸</span>
<h2 class="text-2xl font-bold text-primary"><a href="flower.html">ê½ƒë³´ë¼ê°€ë“ </a></h2>
<span class="text-sm bg-primary/10 text-primary px-3 py-1 rounded-full font-semibold">íŒë§¤ì</span>
</div>
<div class="flex items-center gap-4">
<a href="flower.html" class="text-sm hover:text-primary">ë©”ì¸</a>
<a href="dashboard.html" class="text-sm hover:text-primary">ë§ˆì´í˜ì´ì§€</a>
<button onclick="handleLogout()" class="text-sm text-red-600 hover:text-red-700">ë¡œê·¸ì•„ì›ƒ</button>
</div>
</div>
</header>

<main class="max-w-7xl mx-auto px-6 py-8">
<div class="flex justify-between items-center mb-8">
<div>
<h1 class="text-3xl font-bold mb-2">ë‚´ ìƒí’ˆ ê´€ë¦¬</h1>
<p class="text-gray-600">ë“±ë¡í•œ ìƒí’ˆì„ ê´€ë¦¬í•˜ê³  ìƒˆë¡œìš´ ìƒí’ˆì„ ì¶”ê°€í•˜ì„¸ìš”</p>
</div>
<button onclick="showAddProductModal()" class="bg-primary text-white px-6 py-3 rounded-lg hover:bg-primary/90 font-semibold flex items-center gap-2">
<span class="material-symbols-outlined">add</span>
ìƒí’ˆ ë“±ë¡
</button>
</div>

<!-- ìƒí’ˆ ëª©ë¡ -->
<div id="productList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
<!-- ìƒí’ˆ ì¹´ë“œê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
</div>

<div id="emptyState" class="hidden text-center py-16">
<span class="text-6xl mb-4 block">ğŸ“¦</span>
<h3 class="text-xl font-bold mb-2">ì•„ì§ ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤</h3>
<p class="text-gray-600 mb-6">ì²« ë²ˆì§¸ ìƒí’ˆì„ ë“±ë¡í•´ë³´ì„¸ìš”!</p>
<button onclick="showAddProductModal()" class="bg-primary text-white px-6 py-3 rounded-lg hover:bg-primary/90 font-semibold">
ìƒí’ˆ ë“±ë¡í•˜ê¸°
</button>
</div>
</main>

<!-- ìƒí’ˆ ë“±ë¡/ìˆ˜ì • ëª¨ë‹¬ -->
<div id="productModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
<div class="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
<div class="p-6 border-b flex justify-between items-center sticky top-0 bg-white">
<h2 id="modalTitle" class="text-2xl font-bold">ìƒí’ˆ ë“±ë¡</h2>
<button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
<span class="material-symbols-outlined">close</span>
</button>
</div>

<form id="productForm" class="p-6 space-y-6">
<input type="hidden" id="productEditId" />

<div>
<label class="block text-sm font-semibold mb-2">ìƒí’ˆ ID *</label>
<input type="text" id="productId" required 
    class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary/50"
    placeholder="ì˜ˆ: rose-bouquet-01"/>
<p class="text-xs text-gray-500 mt-1">ì˜ë¬¸ ì†Œë¬¸ì, ìˆ«ì, í•˜ì´í”ˆ(-)ë§Œ ì‚¬ìš©</p>
</div>

<div>
<label class="block text-sm font-semibold mb-2">ìƒí’ˆëª… *</label>
<input type="text" id="productName" required 
    class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary/50"
    placeholder="ì˜ˆ: ë¡œë§¨í‹± ì¥ë¯¸ ê½ƒë‹¤ë°œ"/>
</div>

<div>
<label class="block text-sm font-semibold mb-2">ìƒí’ˆ ì„¤ëª…</label>
<textarea id="productDescription" rows="3"
    class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary/50"
    placeholder="ìƒí’ˆì— ëŒ€í•œ ìì„¸í•œ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
</div>

<div class="grid grid-cols-2 gap-4">
<div>
<label class="block text-sm font-semibold mb-2">íŒë§¤ê°€ *</label>
<input type="number" id="productPrice" required min="0"
    class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary/50"
    placeholder="49900"/>
</div>
<div>
<label class="block text-sm font-semibold mb-2">ì •ê°€</label>
<input type="number" id="productOriginalPrice" min="0"
    class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary/50"
    placeholder="69900"/>
</div>
</div>

<div class="grid grid-cols-2 gap-4">
<div>
<label class="block text-sm font-semibold mb-2">ì¹´í…Œê³ ë¦¬</label>
<select id="productCategory" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary/50">
<option value="">ì„ íƒí•˜ì„¸ìš”</option>
<option value="bouquet">ê½ƒë‹¤ë°œ</option>
<option value="plant">ì‹ë¬¼</option>
<option value="subscription">ì •ê¸°êµ¬ë…</option>
<option value="special">íŠ¹ë³„í•œ ë‚ </option>
<option value="other">ê¸°íƒ€</option>
</select>
</div>
<div>
<label class="block text-sm font-semibold mb-2">ì¬ê³  ìˆ˜ëŸ‰</label>
<input type="number" id="productStock" min="0" value="0"
    class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary/50"/>
</div>
</div>

<div>
<label class="block text-sm font-semibold mb-2">ìƒí’ˆ ì´ë¯¸ì§€ URL</label>
<div id="imageInputs" class="space-y-2">
<input type="url" class="image-url w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary/50" 
    placeholder="https://example.com/image1.jpg"/>
</div>
<button type="button" onclick="addImageInput()" 
    class="mt-2 text-sm text-primary hover:underline">+ ì´ë¯¸ì§€ ì¶”ê°€</button>
</div>

<div class="flex items-center gap-2">
<input type="checkbox" id="productIsActive" checked class="w-4 h-4"/>
<label for="productIsActive" class="text-sm">ìƒí’ˆ í™œì„±í™” (ì²´í¬ í•´ì œ ì‹œ ìˆ¨ê¹€)</label>
</div>

<div class="flex gap-4 pt-4">
<button type="submit" class="flex-1 bg-primary text-white py-3 rounded-lg hover:bg-primary/90 font-semibold">
ì €ì¥í•˜ê¸°
</button>
<button type="button" onclick="closeModal()" class="px-6 py-3 border rounded-lg hover:bg-gray-50">
ì·¨ì†Œ
</button>
</div>
</form>
</div>
</div>

<!-- Supabase Client -->
<script type="module">
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

const SUPABASE_URL = 'https://xebqrsnkimtdlrjylvgy.supabase.co';
const SUPABASE_ANON_KEY = 'sb_publishable_hAxbFj3PjkdVeYqDssDsDQ_aoND-4FU';
window.supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
</script>
<script src="flower.js"></script>
<script>
const API_BASE = window.location.hostname === 'localhost' 
    ? 'http://localhost:3001/api' 
    : 'https://flower-backend-api-g0fuavb9b3gxhqgm.koreacentral-01.azurewebsites.net/api';

let currentProducts = [];

// í˜ì´ì§€ ë¡œë“œ ì‹œ
async function init() {
    const user = await checkAuth();
    if (!user) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        window.location.href = 'login.html';
        return;
    }
    loadProducts();
}

// ìƒí’ˆ ëª©ë¡ ë¡œë“œ
async function loadProducts() {
    try {
        const token = await getAccessToken();
        const response = await fetch(`${API_BASE}/seller/products`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (!response.ok) throw new Error('ìƒí’ˆ ë¡œë“œ ì‹¤íŒ¨');
        
        currentProducts = await response.json();
        renderProducts();
    } catch (error) {
        console.error('ìƒí’ˆ ë¡œë“œ ì—ëŸ¬:', error);
        showNotification('âŒ ìƒí’ˆì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤');
    }
}

// ìƒí’ˆ ëª©ë¡ ë Œë”ë§
function renderProducts() {
    const container = document.getElementById('productList');
    const emptyState = document.getElementById('emptyState');
    
    if (currentProducts.length === 0) {
        container.classList.add('hidden');
        emptyState.classList.remove('hidden');
        return;
    }
    
    container.classList.remove('hidden');
    emptyState.classList.add('hidden');
    
    container.innerHTML = currentProducts.map(product => {
        const images = Array.isArray(product.images) ? product.images : [];
        const mainImage = images[0] || 'https://via.placeholder.com/400';
        const discount = product.original_price 
            ? Math.round((1 - product.price / product.original_price) * 100) 
            : 0;
        
        return `
            <div class="bg-white rounded-xl overflow-hidden shadow-sm border hover:shadow-lg transition-shadow">
                <div class="aspect-square bg-gray-100 relative">
                    <img src="${mainImage}" alt="${product.name}" 
                        class="w-full h-full object-cover" 
                        onerror="this.src='https://via.placeholder.com/400'"/>
                    ${!product.is_active ? '<div class="absolute inset-0 bg-black/50 flex items-center justify-center text-white font-bold">ë¹„í™œì„±</div>' : ''}
                    ${discount > 0 ? `<div class="absolute top-2 left-2 bg-red-500 text-white px-2 py-1 rounded text-sm font-bold">${discount}% í• ì¸</div>` : ''}
                </div>
                <div class="p-4">
                    <h3 class="font-bold text-lg mb-1">${product.name}</h3>
                    <p class="text-sm text-gray-600 mb-2 line-clamp-2">${product.description || ''}</p>
                    <div class="flex items-center gap-2 mb-2">
                        <span class="font-bold text-primary text-xl">${product.price.toLocaleString()}ì›</span>
                        ${product.original_price ? `<span class="text-gray-400 line-through text-sm">${product.original_price.toLocaleString()}ì›</span>` : ''}
                    </div>
                    <div class="flex items-center justify-between text-sm text-gray-500 mb-4">
                        <span>ì¬ê³ : ${product.stock}ê°œ</span>
                        <span class="text-xs bg-gray-100 px-2 py-1 rounded">${product.category || 'ë¯¸ë¶„ë¥˜'}</span>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="editProduct('${product.id}')" 
                            class="flex-1 py-2 border border-primary text-primary rounded-lg hover:bg-primary/10 font-medium">
                            ìˆ˜ì •
                        </button>
                        <button onclick="deleteProduct('${product.id}')" 
                            class="px-4 py-2 border border-red-500 text-red-500 rounded-lg hover:bg-red-50 font-medium">
                            ì‚­ì œ
                        </button>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// ìƒí’ˆ ì¶”ê°€ ëª¨ë‹¬ í‘œì‹œ
function showAddProductModal() {
    document.getElementById('modalTitle').textContent = 'ìƒí’ˆ ë“±ë¡';
    document.getElementById('productForm').reset();
    document.getElementById('productEditId').value = '';
    document.getElementById('productId').disabled = false;
    document.getElementById('productIsActive').checked = true;
    document.getElementById('productModal').classList.remove('hidden');
}

// ìƒí’ˆ ìˆ˜ì •
async function editProduct(id) {
    const product = currentProducts.find(p => p.id === id);
    if (!product) return;
    
    document.getElementById('modalTitle').textContent = 'ìƒí’ˆ ìˆ˜ì •';
    document.getElementById('productEditId').value = product.id;
    document.getElementById('productId').value = product.product_id;
    document.getElementById('productId').disabled = true;
    document.getElementById('productName').value = product.name;
    document.getElementById('productDescription').value = product.description || '';
    document.getElementById('productPrice').value = product.price;
    document.getElementById('productOriginalPrice').value = product.original_price || '';
    document.getElementById('productCategory').value = product.category || '';
    document.getElementById('productStock').value = product.stock;
    document.getElementById('productIsActive').checked = product.is_active;
    
    // ì´ë¯¸ì§€ ì…ë ¥ í•„ë“œ ì¬êµ¬ì„±
    const imageInputs = document.getElementById('imageInputs');
    const images = Array.isArray(product.images) ? product.images : [];
    imageInputs.innerHTML = images.map(url => 
        `<input type="url" class="image-url w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary/50" value="${url}"/>`
    ).join('');
    
    if (images.length === 0) {
        imageInputs.innerHTML = '<input type="url" class="image-url w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary/50" placeholder="https://example.com/image1.jpg"/>';
    }
    
    document.getElementById('productModal').classList.remove('hidden');
}

// ìƒí’ˆ ì‚­ì œ
async function deleteProduct(id) {
    if (!confirm('ì •ë§ ì´ ìƒí’ˆì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    try {
        const token = await getAccessToken();
        const response = await fetch(`${API_BASE}/seller/products/${id}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (!response.ok) throw new Error('ìƒí’ˆ ì‚­ì œ ì‹¤íŒ¨');
        
        showNotification('âœ… ìƒí’ˆì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
        loadProducts();
    } catch (error) {
        console.error('ìƒí’ˆ ì‚­ì œ ì—ëŸ¬:', error);
        showNotification('âŒ ìƒí’ˆ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
    }
}

// ì´ë¯¸ì§€ ì…ë ¥ í•„ë“œ ì¶”ê°€
function addImageInput() {
    const container = document.getElementById('imageInputs');
    const input = document.createElement('input');
    input.type = 'url';
    input.className = 'image-url w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary/50';
    input.placeholder = 'https://example.com/image.jpg';
    container.appendChild(input);
}

// ëª¨ë‹¬ ë‹«ê¸°
function closeModal() {
    document.getElementById('productModal').classList.add('hidden');
}

// í¼ ì œì¶œ
document.getElementById('productForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const editId = document.getElementById('productEditId').value;
    const productId = document.getElementById('productId').value.trim();
    const name = document.getElementById('productName').value.trim();
    const description = document.getElementById('productDescription').value.trim();
    const price = parseInt(document.getElementById('productPrice').value);
    const originalPrice = document.getElementById('productOriginalPrice').value 
        ? parseInt(document.getElementById('productOriginalPrice').value) 
        : null;
    const category = document.getElementById('productCategory').value;
    const stock = parseInt(document.getElementById('productStock').value);
    const isActive = document.getElementById('productIsActive').checked;
    
    // ì´ë¯¸ì§€ URL ìˆ˜ì§‘
    const imageInputs = document.querySelectorAll('.image-url');
    const images = Array.from(imageInputs)
        .map(input => input.value.trim())
        .filter(url => url !== '');
    
    const productData = {
        product_id: productId,
        name,
        description,
        price,
        original_price: originalPrice,
        category,
        stock,
        images,
        is_active: isActive
    };
    
    try {
        const token = await getAccessToken();
        const url = editId 
            ? `${API_BASE}/seller/products/${editId}`
            : `${API_BASE}/seller/products`;
        
        const response = await fetch(url, {
            method: editId ? 'PUT' : 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(productData)
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || 'ì €ì¥ ì‹¤íŒ¨');
        }
        
        showNotification(`âœ… ìƒí’ˆì´ ${editId ? 'ìˆ˜ì •' : 'ë“±ë¡'}ë˜ì—ˆìŠµë‹ˆë‹¤`);
        closeModal();
        loadProducts();
    } catch (error) {
        console.error('ìƒí’ˆ ì €ì¥ ì—ëŸ¬:', error);
        showNotification(`âŒ ${error.message}`);
    }
});

// ë¡œê·¸ì•„ì›ƒ
async function handleLogout() {
    const { error } = await supabase.auth.signOut();
    if (!error) {
        window.location.href = 'login.html';
    }
}

// ì´ˆê¸°í™”
window.showAddProductModal = showAddProductModal;
window.editProduct = editProduct;
window.deleteProduct = deleteProduct;
window.addImageInput = addImageInput;
window.closeModal = closeModal;
window.handleLogout = handleLogout;

setTimeout(init, 500);
</script>
</body>
</html>
