<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>ê´€ë¦¬ì í˜ì´ì§€ | ê½ƒë³´ë¼ê°€ë“ </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols_Outlined&display=swap" rel="stylesheet"/>
    <script id="tailwind-config">
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        "primary": "#2d5f3f"
                    }
                },
            },
        }
    </script>
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400; }
    </style>
</head>
<body class="bg-gray-50">
<header class="sticky top-0 z-50 bg-white/80 backdrop-blur-md border-b">
<div class="max-w-7xl mx-auto px-6 h-20 flex items-center justify-between">
<div class="flex items-center gap-3">
<span class="text-2xl">ğŸŒ¸</span>
<h2 class="text-2xl font-bold text-primary"><a href="flower.html">ê½ƒë³´ë¼ê°€ë“ </a></h2>
<span class="text-sm bg-red-500/10 text-red-600 px-3 py-1 rounded-full font-semibold">ê´€ë¦¬ì</span>
</div>
<div class="flex items-center gap-4">
<a href="flower.html" class="text-sm hover:text-primary">ë©”ì¸</a>
<button onclick="handleLogout()" class="text-sm text-red-600 hover:text-red-700">ë¡œê·¸ì•„ì›ƒ</button>
</div>
</div>
</header>

<main class="max-w-7xl mx-auto px-6 py-8">
<!-- íƒ­ -->
<div class="flex gap-4 mb-8 border-b">
<button onclick="showTab('users')" id="usersTab" class="px-6 py-3 font-semibold border-b-2 border-primary text-primary">
ì‚¬ìš©ì ê´€ë¦¬
</button>
<button onclick="showTab('products')" id="productsTab" class="px-6 py-3 font-semibold text-gray-500 hover:text-primary">
ìƒí’ˆ ê´€ë¦¬
</button>
<button onclick="showTab('orders')" id="ordersTab" class="px-6 py-3 font-semibold text-gray-500 hover:text-primary">
ì£¼ë¬¸ ê´€ë¦¬
</button>
</div>

<!-- ì‚¬ìš©ì ê´€ë¦¬ íƒ­ -->
<div id="usersContent" class="tab-content">
<div class="flex justify-between items-center mb-6">
<h2 class="text-2xl font-bold">ì‚¬ìš©ì ê´€ë¦¬</h2>
<span id="userCount" class="text-gray-600"></span>
</div>

<div class="bg-white rounded-lg shadow overflow-hidden">
<table class="w-full">
<thead class="bg-gray-50 border-b">
<tr>
<th class="px-6 py-3 text-left text-sm font-semibold">ì´ë©”ì¼</th>
<th class="px-6 py-3 text-left text-sm font-semibold">ì´ë¦„</th>
<th class="px-6 py-3 text-left text-sm font-semibold">ì—­í• </th>
<th class="px-6 py-3 text-left text-sm font-semibold">í¬ì¸íŠ¸</th>
<th class="px-6 py-3 text-left text-sm font-semibold">ê°€ì…ì¼</th>
<th class="px-6 py-3 text-left text-sm font-semibold">ê´€ë¦¬</th>
</tr>
</thead>
<tbody id="usersTable" class="divide-y">
</tbody>
</table>
</div>
</div>

<!-- ìƒí’ˆ ê´€ë¦¬ íƒ­ -->
<div id="productsContent" class="tab-content hidden">
<div class="flex justify-between items-center mb-6">
<h2 class="text-2xl font-bold">ì „ì²´ ìƒí’ˆ</h2>
<span id="productCount" class="text-gray-600"></span>
</div>

<div id="productList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
</div>
</div>

<!-- ì£¼ë¬¸ ê´€ë¦¬ íƒ­ -->
<div id="ordersContent" class="tab-content hidden">
<div class="flex justify-between items-center mb-6">
<h2 class="text-2xl font-bold">ì£¼ë¬¸ ê´€ë¦¬</h2>
<span id="orderCount" class="text-gray-600"></span>
</div>
<div class="bg-white rounded-lg shadow p-6 text-center text-gray-500">
ì£¼ë¬¸ ê´€ë¦¬ ê¸°ëŠ¥ì€ ê³§ ì¶”ê°€ë©ë‹ˆë‹¤
</div>
</div>
</main>

<!-- Supabase Client -->
<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'

const SUPABASE_URL = 'https://xebqrsnkimtdlrjylvgy.supabase.co';
const SUPABASE_ANON_KEY = 'sb_publishable_hAxbFj3PjkdVeYqDssDsDQ_aoND-4FU';
window.supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
</script>
<script src="flower.js"></script>
<script>
const API_BASE = window.location.hostname === 'localhost' 
    ? 'http://localhost:3001/api' 
    : 'https://flower-backend-api-g0fuavb9b3gxhqgm.koreacentral-01.azurewebsites.net/api';

let currentUsers = [];
let currentProducts = [];

// í˜ì´ì§€ ë¡œë“œ ì‹œ
async function init() {
    const user = await checkAuth();
    if (!user) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        window.location.href = 'login.html';
        return;
    }
    
    // ê´€ë¦¬ì ê¶Œí•œ í™•ì¸ì€ API í˜¸ì¶œ ì‹œ ì„œë²„ì—ì„œ ì²˜ë¦¬
    loadUsers();
}

// íƒ­ ì „í™˜
function showTab(tab) {
    // ëª¨ë“  íƒ­ ì½˜í…ì¸  ìˆ¨ê¸°ê¸°
    document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
    
    // ëª¨ë“  íƒ­ ë²„íŠ¼ ë¹„í™œì„±í™”
    document.querySelectorAll('[id$="Tab"]').forEach(btn => {
        btn.classList.remove('border-b-2', 'border-primary', 'text-primary');
        btn.classList.add('text-gray-500');
    });
    
    // ì„ íƒí•œ íƒ­ í™œì„±í™”
    document.getElementById(`${tab}Content`).classList.remove('hidden');
    document.getElementById(`${tab}Tab`).classList.add('border-b-2', 'border-primary', 'text-primary');
    document.getElementById(`${tab}Tab`).classList.remove('text-gray-500');
    
    // ë°ì´í„° ë¡œë“œ
    if (tab === 'users') loadUsers();
    if (tab === 'products') loadProducts();
}

// ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ
async function loadUsers() {
    try {
        const token = await getAccessToken();
        const response = await fetch(`${API_BASE}/admin/users`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (!response.ok) {
            if (response.status === 403) {
                alert('ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = 'dashboard.html';
                return;
            }
            throw new Error('ì‚¬ìš©ì ë¡œë“œ ì‹¤íŒ¨');
        }
        
        currentUsers = await response.json();
        renderUsers();
    } catch (error) {
        console.error('ì‚¬ìš©ì ë¡œë“œ ì—ëŸ¬:', error);
        showNotification('âŒ ì‚¬ìš©ìë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤');
    }
}

// ì‚¬ìš©ì ëª©ë¡ ë Œë”ë§
function renderUsers() {
    const tbody = document.getElementById('usersTable');
    document.getElementById('userCount').textContent = `ì´ ${currentUsers.length}ëª…`;
    
    tbody.innerHTML = currentUsers.map(user => {
        const roleColors = {
            admin: 'bg-red-100 text-red-700',
            seller: 'bg-blue-100 text-blue-700',
            customer: 'bg-gray-100 text-gray-700'
        };
        const roleNames = {
            admin: 'ê´€ë¦¬ì',
            seller: 'íŒë§¤ì',
            customer: 'ê³ ê°'
        };
        
        return `
            <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 text-sm">${user.email}</td>
                <td class="px-6 py-4 text-sm">${user.name || '-'}</td>
                <td class="px-6 py-4 text-sm">
                    <span class="px-3 py-1 rounded-full text-xs font-semibold ${roleColors[user.role] || roleColors.customer}">
                        ${roleNames[user.role] || 'ê³ ê°'}
                    </span>
                </td>
                <td class="px-6 py-4 text-sm">${(user.total_points || 0).toLocaleString()}P</td>
                <td class="px-6 py-4 text-sm text-gray-500">${new Date(user.created_at).toLocaleDateString()}</td>
                <td class="px-6 py-4 text-sm">
                    <select onchange="changeUserRole('${user.id}', this.value)" 
                        class="px-3 py-1 border rounded text-sm"
                        ${user.role === 'admin' ? 'disabled' : ''}>
                        <option value="customer" ${user.role === 'customer' ? 'selected' : ''}>ê³ ê°</option>
                        <option value="seller" ${user.role === 'seller' ? 'selected' : ''}>íŒë§¤ì</option>
                        <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>ê´€ë¦¬ì</option>
                    </select>
                </td>
            </tr>
        `;
    }).join('');
}

// ì‚¬ìš©ì ì—­í•  ë³€ê²½
async function changeUserRole(userId, newRole) {
    if (!confirm(`ì´ ì‚¬ìš©ìì˜ ì—­í• ì„ ${newRole}(ìœ¼)ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        loadUsers(); // ì›ë˜ëŒ€ë¡œ ë˜ëŒë¦¬ê¸°
        return;
    }
    
    try {
        const token = await getAccessToken();
        const response = await fetch(`${API_BASE}/admin/users/${userId}/role`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ role: newRole })
        });
        
        if (!response.ok) throw new Error('ì—­í•  ë³€ê²½ ì‹¤íŒ¨');
        
        showNotification('âœ… ì—­í• ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤');
        loadUsers();
    } catch (error) {
        console.error('ì—­í•  ë³€ê²½ ì—ëŸ¬:', error);
        showNotification('âŒ ì—­í•  ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
        loadUsers();
    }
}

// ìƒí’ˆ ëª©ë¡ ë¡œë“œ
async function loadProducts() {
    try {
        const token = await getAccessToken();
        const response = await fetch(`${API_BASE}/admin/products`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (!response.ok) throw new Error('ìƒí’ˆ ë¡œë“œ ì‹¤íŒ¨');
        
        currentProducts = await response.json();
        renderProducts();
    } catch (error) {
        console.error('ìƒí’ˆ ë¡œë“œ ì—ëŸ¬:', error);
        showNotification('âŒ ìƒí’ˆì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤');
    }
}

// ìƒí’ˆ ëª©ë¡ ë Œë”ë§
function renderProducts() {
    const container = document.getElementById('productList');
    document.getElementById('productCount').textContent = `ì´ ${currentProducts.length}ê°œ`;
    
    container.innerHTML = currentProducts.map(product => {
        const images = Array.isArray(product.images) ? product.images : [];
        const mainImage = images[0] || 'https://via.placeholder.com/400';
        const sellerName = product.seller?.name || product.seller?.email || 'ì•Œ ìˆ˜ ì—†ìŒ';
        
        return `
            <div class="bg-white rounded-xl overflow-hidden shadow-sm border">
                <div class="aspect-square bg-gray-100 relative">
                    <img src="${mainImage}" alt="${product.name}" 
                        class="w-full h-full object-cover"
                        onerror="this.src='https://via.placeholder.com/400'"/>
                    ${!product.is_active ? '<div class="absolute inset-0 bg-black/50 flex items-center justify-center text-white font-bold">ë¹„í™œì„±</div>' : ''}
                </div>
                <div class="p-4">
                    <h3 class="font-bold mb-1">${product.name}</h3>
                    <p class="text-sm text-gray-600 mb-2">íŒë§¤ì: ${sellerName}</p>
                    <p class="font-bold text-primary mb-2">${product.price.toLocaleString()}ì›</p>
                    <div class="flex items-center justify-between text-xs text-gray-500">
                        <span>ì¬ê³ : ${product.stock}ê°œ</span>
                        <span>${product.category || 'ë¯¸ë¶„ë¥˜'}</span>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// ë¡œê·¸ì•„ì›ƒ
async function handleLogout() {
    const { error } = await supabase.auth.signOut();
    if (!error) {
        window.location.href = 'login.html';
    }
}

// ì´ˆê¸°í™”
window.showTab = showTab;
window.changeUserRole = changeUserRole;
window.handleLogout = handleLogout;

setTimeout(init, 500);
</script>
</body>
</html>
